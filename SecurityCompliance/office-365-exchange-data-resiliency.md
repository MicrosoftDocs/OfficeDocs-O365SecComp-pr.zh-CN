---
title: Office 365 Exchange 数据弹性
ms.author: robmazz
author: robmazz
manager: laurawi
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- Strat_O365_IP
- M365-security-compliance
description: Exchange Online 和 Office 365 中数据弹性的各个方面的说明。
ms.openlocfilehash: 96611c2db166e34a47b845b5683a367dd29ec25f
ms.sourcegitcommit: f0d23e57b00f07cef5b1b2d366eaeeeacda37e3e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/18/2019
ms.locfileid: "35786667"
---
# <a name="exchange-online-data-resiliency-in-office-365"></a><span data-ttu-id="78fa7-103">Office 365 中的 Exchange Online 数据恢复能力</span><span class="sxs-lookup"><span data-stu-id="78fa7-103">Exchange Online Data Resiliency in Office 365</span></span>

## <a name="introduction"></a><span data-ttu-id="78fa7-104">简介</span><span class="sxs-lookup"><span data-stu-id="78fa7-104">Introduction</span></span>
<span data-ttu-id="78fa7-105">有两种类型的损坏可能会影响 Exchange 数据库: 物理损坏通常是由硬件 (尤其是存储硬件) 问题引起的, 以及因其他因素而发生的逻辑损坏。</span><span class="sxs-lookup"><span data-stu-id="78fa7-105">There are two types of corruption that can affect an Exchange database: physical corruption, which is typically caused by hardware (in particular, storage hardware) problems, and logical corruption, which occurs due to other factors.</span></span> <span data-ttu-id="78fa7-106">通常情况下, Exchange 数据库中可能发生两种类型的逻辑损坏:</span><span class="sxs-lookup"><span data-stu-id="78fa7-106">Generally, there are two types of logical corruption that can occur within an Exchange database:</span></span> 
- <span data-ttu-id="78fa7-107">**数据库逻辑损坏**-数据库页的校验和匹配, 但页面上的数据在逻辑上是错误的。</span><span class="sxs-lookup"><span data-stu-id="78fa7-107">**Database logical corruption** - The database page checksum matches, but the data on the page is wrong logically.</span></span> <span data-ttu-id="78fa7-108">如果数据库引擎 (可扩展存储引擎 (ESE)) 尝试写入数据库页面, 即使操作系统返回成功消息, 但数据永远不会写入磁盘或写入错误的位置, 则可能会发生这种情况。</span><span class="sxs-lookup"><span data-stu-id="78fa7-108">This can occur when the database engine (the Extensible Storage Engine (ESE)) attempts to write a database page and even though the operating system returns a success message, the data is either never written to the disk or it's written to the wrong place.</span></span> <span data-ttu-id="78fa7-109">这称为 "*丢失的刷新*"。</span><span class="sxs-lookup"><span data-stu-id="78fa7-109">This is referred to as a *lost flush*.</span></span> <span data-ttu-id="78fa7-110">ESE 包含的许多功能和保护措施旨在防止数据库的物理损坏和其他数据丢失场景。</span><span class="sxs-lookup"><span data-stu-id="78fa7-110">ESE includes numerous features and safeguards that are designed to prevent physical corruption of a database and other data loss scenarios.</span></span> <span data-ttu-id="78fa7-111">为了防止丢失刷新丢失的数据, ESE 在数据库中包含丢失的刷新机制以及一个功能 (单页还原) 以更正它。</span><span class="sxs-lookup"><span data-stu-id="78fa7-111">To prevent lost flushes from losing data, ESE includes a lost flush detection mechanism in the database along with a feature (single page restore) to correct it.</span></span> 
- <span data-ttu-id="78fa7-112">**存储逻辑损坏**-以用户不期望的方式添加、删除或操作数据。</span><span class="sxs-lookup"><span data-stu-id="78fa7-112">**Store logical corruption** - Data is added, deleted, or manipulated in a way that the user doesn't expect.</span></span> <span data-ttu-id="78fa7-113">这些情况通常都是由第三方应用程序引起的。</span><span class="sxs-lookup"><span data-stu-id="78fa7-113">These cases are generally caused by third-party applications.</span></span> <span data-ttu-id="78fa7-114">通常在用户将其看作损坏时才认为是损坏的。</span><span class="sxs-lookup"><span data-stu-id="78fa7-114">It's generally only corruption in the sense that the user views it as corruption.</span></span> <span data-ttu-id="78fa7-115">Exchange 存储会考虑产生一系列有效 MAPI 操作的逻辑损坏的事务。</span><span class="sxs-lookup"><span data-stu-id="78fa7-115">The Exchange store considers the transaction that produced the logical corruption to be a series of valid MAPI operations.</span></span> <span data-ttu-id="78fa7-116">Exchange Online 中的[就地保留](https://docs.microsoft.com/exchange/security-and-compliance/create-or-remove-in-place-holds)功能提供了对存储逻辑损坏的保护 (因为它会阻止用户或应用程序永久删除内容)。</span><span class="sxs-lookup"><span data-stu-id="78fa7-116">The [In-Place Hold](https://docs.microsoft.com/exchange/security-and-compliance/create-or-remove-in-place-holds) features in Exchange Online provides protection from store logical corruption (because it prevents content from being permanently deleted by a user or an application).</span></span> 

<span data-ttu-id="78fa7-117">Exchange Online 在日志检查和日志重播期间对复制的日志文件执行几项一致性检查。</span><span class="sxs-lookup"><span data-stu-id="78fa7-117">Exchange Online performs several consistency checks on replicated log files during both log inspection and log replay.</span></span> <span data-ttu-id="78fa7-118">这些一致性检查防止系统复制物理损坏。</span><span class="sxs-lookup"><span data-stu-id="78fa7-118">These consistency checks prevent physical corruption from being replicated by the system.</span></span> <span data-ttu-id="78fa7-119">例如, 在日志检查过程中, 有一个物理完整性检查, 它会验证日志文件, 并验证日志文件中记录的校验和是否与内存中生成的校验和相匹配。</span><span class="sxs-lookup"><span data-stu-id="78fa7-119">For example, during log inspection, there is a physical integrity check which verifies the log file and validates that the checksum recorded in the log file matches the checksum generated in memory.</span></span> <span data-ttu-id="78fa7-120">此外, 还会检查日志文件头, 以确保日志文件头中记录的日志文件签名与日志文件的签名相匹配。</span><span class="sxs-lookup"><span data-stu-id="78fa7-120">In addition, the log file header is examined to make sure the log file signature recorded in the log header matches that of the log file.</span></span> <span data-ttu-id="78fa7-121">在日志重播过程中, 日志文件会经历进一步的审查。</span><span class="sxs-lookup"><span data-stu-id="78fa7-121">During log replay, the log file undergoes further scrutiny.</span></span> <span data-ttu-id="78fa7-122">例如, 数据库标头还包含与日志文件的签名进行比较的日志签名, 以确保它们相匹配。</span><span class="sxs-lookup"><span data-stu-id="78fa7-122">For example, the database header also contains the log signature which is compared with the log file's signature to ensure they match.</span></span> 

<span data-ttu-id="78fa7-123">对 Exchange Online 中邮箱数据的损坏进行保护是通过使用 Exchange 本机数据保护实现的, 这是一种可跨多个服务器和多个数据中心以及其他数据中心使用应用程序级别复制的复原策略帮助防止数据因损坏或其他原因而丢失的功能。</span><span class="sxs-lookup"><span data-stu-id="78fa7-123">Protection against corruption of mailbox data in Exchange Online is achieved by using Exchange Native Data Protection, a resiliency strategy that leverages application-level replication across multiple servers and multiple datacenters along with other features that help protect data from being lost due to corruption or other reasons.</span></span> <span data-ttu-id="78fa7-124">这些功能包括由 Microsoft 或 Exchange Online 应用程序本身管理的本机功能, 如:</span><span class="sxs-lookup"><span data-stu-id="78fa7-124">These features include native features that are managed by Microsoft or the Exchange Online application itself, such as:</span></span>

- [<span data-ttu-id="78fa7-125">数据可用性组</span><span class="sxs-lookup"><span data-stu-id="78fa7-125">Data Availability Groups</span></span>](https://docs.microsoft.com/exchange/back-up-email)
- <span data-ttu-id="78fa7-126">单一位更正</span><span class="sxs-lookup"><span data-stu-id="78fa7-126">Single Bit Correction</span></span> 
- <span data-ttu-id="78fa7-127">在线数据库扫描</span><span class="sxs-lookup"><span data-stu-id="78fa7-127">Online Database Scanning</span></span> 
- <span data-ttu-id="78fa7-128">刷新检测丢失</span><span class="sxs-lookup"><span data-stu-id="78fa7-128">Lost Flush Detection</span></span> 
- <span data-ttu-id="78fa7-129">单个页面还原</span><span class="sxs-lookup"><span data-stu-id="78fa7-129">Single Page Restore</span></span> 
- <span data-ttu-id="78fa7-130">邮箱复制服务</span><span class="sxs-lookup"><span data-stu-id="78fa7-130">Mailbox Replication Service</span></span> 
- <span data-ttu-id="78fa7-131">日志文件检查</span><span class="sxs-lookup"><span data-stu-id="78fa7-131">Log File Checks</span></span> 
- <span data-ttu-id="78fa7-132">在弹性文件系统上部署</span><span class="sxs-lookup"><span data-stu-id="78fa7-132">Deployment on Resilient File System</span></span> 

<span data-ttu-id="78fa7-133">有关上面列出的本机功能的详细信息, 请单击上面的超链接, 并查看有关不带超链接的项目的详细信息。</span><span class="sxs-lookup"><span data-stu-id="78fa7-133">For more information on the native features listed above, click on the above hyperlinks, and see below for additional information and for details on items without hyperlinks.</span></span> <span data-ttu-id="78fa7-134">除了这些本机功能之外, Exchange Online 还包括客户可以管理的数据恢复功能, 如:</span><span class="sxs-lookup"><span data-stu-id="78fa7-134">In addition to these native features, Exchange Online also includes data resiliency features that customers can manage, such as:</span></span> 
- [<span data-ttu-id="78fa7-135">单个项目恢复 (默认情况下已启用)</span><span class="sxs-lookup"><span data-stu-id="78fa7-135">Single Item Recovery (enabled by default)</span></span>](https://docs.microsoft.com/exchange/recipients-in-exchange-online/manage-user-mailboxes/recover-deleted-messages) 
- [<span data-ttu-id="78fa7-136">就地保留和诉讼保留</span><span class="sxs-lookup"><span data-stu-id="78fa7-136">In-Place Hold and Litigation Hold</span></span>](https://docs.microsoft.com/exchange/security-and-compliance/in-place-and-litigation-holds) 
- [<span data-ttu-id="78fa7-137">已删除邮件保留和软删除邮箱 (默认情况下启用)</span><span class="sxs-lookup"><span data-stu-id="78fa7-137">Deleted Item Retention and Soft-Deleted Mailboxes (both enabled by default)</span></span>](https://docs.microsoft.com/exchange/recipients-in-exchange-online/delete-or-restore-mailboxes) 

## <a name="database-availability-groups"></a><span data-ttu-id="78fa7-138">数据库可用性组</span><span class="sxs-lookup"><span data-stu-id="78fa7-138">Database Availability Groups</span></span> 
<span data-ttu-id="78fa7-139">Office 365 中的每个邮箱数据库都托管在[数据库可用性组 (DAG)](https://docs.microsoft.com/exchange/back-up-email)中, 并复制到同一区域中的地理位置不同的数据中心。</span><span class="sxs-lookup"><span data-stu-id="78fa7-139">Every mailbox database in Office 365 is hosted in a [database availability group (DAG)](https://docs.microsoft.com/exchange/back-up-email) and replicated to geographically-separate datacenters within the same region.</span></span> <span data-ttu-id="78fa7-140">最常见的配置是四个数据中心中的四个数据库副本;但是, 有些区域的数据中心较少 (数据库将被复制到印度的三个数据中心和澳大利亚和日本的两个数据中心)。</span><span class="sxs-lookup"><span data-stu-id="78fa7-140">The most common configuration is four database copies in four datacenters; however, some regions have fewer datacenters (databases are replicated to three datacenters in India, and two datacenters in Australia and Japan).</span></span> <span data-ttu-id="78fa7-141">但在所有情况下, 每个邮箱数据库都有四个跨多个数据中心分布的副本, 因此可确保邮箱数据免受软件、硬件甚至数据中心故障的保护。</span><span class="sxs-lookup"><span data-stu-id="78fa7-141">But in all cases, every mailbox database has four copies that are distributed across multiple datacenters, thereby ensuring that mailbox data is protected from software, hardware, and even datacenter failures.</span></span> 

<span data-ttu-id="78fa7-142">在这四个副本中, 其中有三个配置为高可用性。</span><span class="sxs-lookup"><span data-stu-id="78fa7-142">Out of these four copies, three of them are configured as highly available.</span></span> <span data-ttu-id="78fa7-143">第四个副本配置为[滞后数据库副本](https://docs.microsoft.com/Exchange/high-availability/manage-ha/activate-lagged-db-copies)。</span><span class="sxs-lookup"><span data-stu-id="78fa7-143">The fourth copy is configured as a [lagged database copy](https://docs.microsoft.com/Exchange/high-availability/manage-ha/activate-lagged-db-copies).</span></span> <span data-ttu-id="78fa7-144">滞后数据库副本不用于单个邮箱恢复或邮箱项目恢复。</span><span class="sxs-lookup"><span data-stu-id="78fa7-144">The lagged database copy is not intended for individual mailbox recovery or mailbox item recovery.</span></span> <span data-ttu-id="78fa7-145">其目的是针对系统范围的灾难性逻辑损坏的罕见事件提供恢复机制。</span><span class="sxs-lookup"><span data-stu-id="78fa7-145">Its purpose is to provide a recovery mechanism for the rare event of system-wide, catastrophic logical corruption.</span></span> 

<span data-ttu-id="78fa7-146">Exchange Online 中的滞后数据库副本配置了为期七天的日志文件重播延迟时间。</span><span class="sxs-lookup"><span data-stu-id="78fa7-146">Lagged database copies in Exchange Online are configured with a seven-day log file replay lag time.</span></span> <span data-ttu-id="78fa7-147">此外, Exchange 重播延迟管理器已启用, 以提供滞后副本的动态日志文件, 以允许滞后数据库副本进行自我修复和管理日志文件增长。</span><span class="sxs-lookup"><span data-stu-id="78fa7-147">In addition, the Exchange Replay Lag Manager is enabled to provide dynamic log file play down for lagged copies to allow lagged database copies to self-repair and manage log file growth.</span></span> <span data-ttu-id="78fa7-148">尽管滞后数据库副本在 Exchange Online 中使用, 但务必要了解它们不是一个可保证的时间点备份。</span><span class="sxs-lookup"><span data-stu-id="78fa7-148">Although lagged database copies are used in Exchange Online, it is important to understand that they are not a guaranteed point-in-time backup.</span></span> <span data-ttu-id="78fa7-149">Exchange Online 中的滞后数据库副本具有可用性阈值 (通常约为 90%), 因为由于磁盘故障导致包含滞后副本的磁盘丢失, 因此滞后副本将变为高可用性副本 (由于自动播放), 也是如此在滞后数据库副本重新生成日志重播队列的时段。</span><span class="sxs-lookup"><span data-stu-id="78fa7-149">Lagged database copies in Exchange Online have an availability threshold, typically around 90%, due to periods where the disk containing a lagged copy is lost due to disk failure, the lagged copy becoming a highly-available copy (due to automatic play down), as well as the periods where the lagged database copy is re-building the log replay queue.</span></span> 

## <a name="transport-resilience"></a><span data-ttu-id="78fa7-150">传输弹性</span><span class="sxs-lookup"><span data-stu-id="78fa7-150">Transport Resilience</span></span> 
<span data-ttu-id="78fa7-151">Exchange Online 包括两种主要传输复原功能: 卷影冗余和安全网络。</span><span class="sxs-lookup"><span data-stu-id="78fa7-151">Exchange Online includes two primary transport resilience features: Shadow Redundancy and Safety Net.</span></span> <span data-ttu-id="78fa7-152">"卷影冗余" 在传输过程中保留邮件的冗余副本。</span><span class="sxs-lookup"><span data-stu-id="78fa7-152">Shadow Redundancy keeps a redundant copy of a message while it is in transit.</span></span> <span data-ttu-id="78fa7-153">安全网络在邮件成功传递后保留邮件的冗余副本。</span><span class="sxs-lookup"><span data-stu-id="78fa7-153">Safety Net keeps a redundant copy of a message after the message is successfully delivered.</span></span> 

<span data-ttu-id="78fa7-154">使用卷影冗余, 每个 Exchange Online 传输服务器在确认成功接收发送到发送服务器的邮件之前, 会为每个收到的邮件创建一个副本。</span><span class="sxs-lookup"><span data-stu-id="78fa7-154">With Shadow Redundancy, each Exchange Online transport server makes a copy of each message it receives before it acknowledges successfully receiving the message to the sending server.</span></span> <span data-ttu-id="78fa7-155">这将使传输管道中的所有邮件在传输过程中冗余。</span><span class="sxs-lookup"><span data-stu-id="78fa7-155">This makes all messages in the transport pipeline redundant while in transit.</span></span> <span data-ttu-id="78fa7-156">如果 Exchange Online 确定原始邮件在传输过程中丢失, 将重新发送邮件的冗余副本。</span><span class="sxs-lookup"><span data-stu-id="78fa7-156">If Exchange Online determines the original message was lost in transit, a redundant copy of the message is redelivered.</span></span> 

<span data-ttu-id="78fa7-157">安全网络是与邮箱服务器上的传输服务相关联的传输队列。</span><span class="sxs-lookup"><span data-stu-id="78fa7-157">Safety Net is a transport queue that is associated with the Transport service on a Mailbox server.</span></span> <span data-ttu-id="78fa7-158">此队列存储服务器成功处理的邮件的副本。</span><span class="sxs-lookup"><span data-stu-id="78fa7-158">This queue stores copies of messages that were successfully processed by the server.</span></span> <span data-ttu-id="78fa7-159">当邮箱数据库或服务器故障需要激活邮箱数据库的过期副本时, 安全网络队列中的邮件将自动重新提交到邮箱数据库的新活动副本。</span><span class="sxs-lookup"><span data-stu-id="78fa7-159">When a mailbox database or server failure requires activating an out-of-date copy of the mailbox database, messages in the Safety Net queue are automatically resubmitted to the new active copy of the mailbox database.</span></span> <span data-ttu-id="78fa7-160">安全网络也是冗余的, 因此消除了作为单一故障点的传输。</span><span class="sxs-lookup"><span data-stu-id="78fa7-160">Safety Net is also redundant, thereby eliminating transport as a single point of failure.</span></span> <span data-ttu-id="78fa7-161">它使用主安全网络的概念和阴影安全网络 (如果主安全网络不可用超过12个小时), 重新提交请求将变为 "卷影重新提交请求", 并从 "卷影安全网络" 重新传递邮件。</span><span class="sxs-lookup"><span data-stu-id="78fa7-161">It uses the concept of a Primary Safety Net and a Shadow Safety Net wherein if the Primary Safety Net is unavailable for more than 12 hours, resubmit requests become shadow resubmit requests, and messages are re-delivered from the Shadow Safety Net.</span></span>

<span data-ttu-id="78fa7-162">来自安全网络的邮件重新提交由管理 Dag 和邮箱数据库副本的 Microsoft Exchange 复制服务的活动管理器组件自动启动。</span><span class="sxs-lookup"><span data-stu-id="78fa7-162">Message resubmissions from Safety Net are automatically initiated by the Active Manager component of the Microsoft Exchange Replication service that manages DAGs and mailbox database copies.</span></span> <span data-ttu-id="78fa7-163">重新提交安全网络中的邮件不需要手动操作。</span><span class="sxs-lookup"><span data-stu-id="78fa7-163">No manual actions are required to resubmit messages from Safety Net.</span></span> 

## <a name="single-bit-correction"></a><span data-ttu-id="78fa7-164">单一位更正</span><span class="sxs-lookup"><span data-stu-id="78fa7-164">Single Bit Correction</span></span> 
<span data-ttu-id="78fa7-165">ESE 包括一种机制, 用于检测和解决因硬件错误而导致的单一位 CRC 错误 (亦称为 "一位翻转") (如此, 它们代表物理损坏)。</span><span class="sxs-lookup"><span data-stu-id="78fa7-165">ESE includes a mechanism to detect and resolve single-bit CRC errors (aka single-bit flips) that are the result of hardware errors (and as such they represent physical corruption).</span></span> <span data-ttu-id="78fa7-166">发生这些错误时, ESE 会自动更正这些错误, 并在事件日志中记录事件。</span><span class="sxs-lookup"><span data-stu-id="78fa7-166">When these errors occur, ESE automatically corrects them and logs an event in the event log.</span></span> 

## <a name="online-database-scanning"></a><span data-ttu-id="78fa7-167">在线数据库扫描</span><span class="sxs-lookup"><span data-stu-id="78fa7-167">Online Database Scanning</span></span> 
<span data-ttu-id="78fa7-168">在线数据库扫描 (也称为*数据库校验*和) 是一个过程, ESE 使用数据库一致性检查器读取每个页面并检查页面损坏情况。</span><span class="sxs-lookup"><span data-stu-id="78fa7-168">Online database scanning (also known as *database checksumming*) is the process where an ESE uses a database consistency checker to read each page and check for page corruption.</span></span> <span data-ttu-id="78fa7-169">主要目的是检测事务操作可能无法检测到的物理损坏和丢失刷新。</span><span class="sxs-lookup"><span data-stu-id="78fa7-169">The primary purpose is to detect physical corruption and lost flushes that may not be getting detected by transactional operations.</span></span> <span data-ttu-id="78fa7-170">数据库扫描还会执行存储后崩溃操作。</span><span class="sxs-lookup"><span data-stu-id="78fa7-170">Database scanning also performs post-store crash operations.</span></span> <span data-ttu-id="78fa7-171">空间可能因故障而泄漏, 联机数据库扫描发现并恢复丢失的空间。</span><span class="sxs-lookup"><span data-stu-id="78fa7-171">Space can be leaked due to crashes, and online database scanning finds and recovers lost space.</span></span> <span data-ttu-id="78fa7-172">系统设计时假定每七天完全扫描一次每个数据库。</span><span class="sxs-lookup"><span data-stu-id="78fa7-172">The system is designed with the expectation that every database is fully scanned once every seven days.</span></span> 

## <a name="lost-flush-detection"></a><span data-ttu-id="78fa7-173">刷新检测丢失</span><span class="sxs-lookup"><span data-stu-id="78fa7-173">Lost Flush Detection</span></span> 
<span data-ttu-id="78fa7-174">当磁盘子系统/操作系统返回为已完成的数据库写入操作实际上没有写入磁盘或写入错误的位置时, 将发生刷新丢失。</span><span class="sxs-lookup"><span data-stu-id="78fa7-174">A lost flush occurs when a database write operation that the disk subsystem/operating system returned as completed did not actually get written to disk, or was written in the wrong location.</span></span> <span data-ttu-id="78fa7-175">丢失刷新事件可能会导致数据库逻辑损坏, 因此, 为了防止丢失因丢失数据而导致的刷新, ESE 包含丢失的刷新检测机制。</span><span class="sxs-lookup"><span data-stu-id="78fa7-175">Lost flush incidents can result in database logical corruption, so to prevent lost flushes from resulting in lost data, ESE includes a lost flush detection mechanism.</span></span> <span data-ttu-id="78fa7-176">在将数据库页面写入被动副本时, 将对活动副本上的丢失刷新执行检查。</span><span class="sxs-lookup"><span data-stu-id="78fa7-176">As database pages are written to passive copies, a check is performed for lost flushes on the active copy.</span></span> <span data-ttu-id="78fa7-177">如果检测到丢失的刷新, ESE 可以使用页面修补过程修复进程。</span><span class="sxs-lookup"><span data-stu-id="78fa7-177">If a lost flush is detected, ESE can repair the process using a page patching process.</span></span> 

## <a name="single-page-restore"></a><span data-ttu-id="78fa7-178">单个页面还原</span><span class="sxs-lookup"><span data-stu-id="78fa7-178">Single Page Restore</span></span> 
<span data-ttu-id="78fa7-179">单页还原 (亦称为 "*页面修补*") 是一种自动过程, 在正常的副本中由正常副本替换损坏的数据库页面。</span><span class="sxs-lookup"><span data-stu-id="78fa7-179">Single page restore, aka *page patching*, is an automatic process where corrupt database pages are replaced by healthy copies from a healthy replica.</span></span> <span data-ttu-id="78fa7-180">损坏页面的修复过程取决于数据库副本是活动的还是被动的。</span><span class="sxs-lookup"><span data-stu-id="78fa7-180">The repair process for a corrupt page depends on whether the database copy is active or passive.</span></span> <span data-ttu-id="78fa7-181">当活动数据库副本遇到损坏的页面时, 可以从其副本之一复制页面, 前提是它复制的页面完全是最新的。</span><span class="sxs-lookup"><span data-stu-id="78fa7-181">When an active database copy encounters a corrupted page, it can copy a page from one of its replicas, provided the page it copies is completely up-to-date.</span></span> <span data-ttu-id="78fa7-182">为此, 请将对页面的请求放入日志流中, 这是邮箱数据库复制的基础。</span><span class="sxs-lookup"><span data-stu-id="78fa7-182">This is accomplished by putting a request for the page into the log stream, which is the basis of mailbox database replication.</span></span> <span data-ttu-id="78fa7-183">一旦副本遇到页面请求, 它就会将页面的副本发送到请求数据库副本, 以进行响应。</span><span class="sxs-lookup"><span data-stu-id="78fa7-183">As soon as a replica encounters the page request it responds by sending a copy of the page to the requesting database copy.</span></span> <span data-ttu-id="78fa7-184">单页还原还提供了主动的异步通信机制, 可从副本中请求页面, 即使副本当前处于脱机状态也是如此。</span><span class="sxs-lookup"><span data-stu-id="78fa7-184">Single page restore also provides an asynchronous communication mechanism for the active to request a page from replicas, even if the replicas are currently offline.</span></span> 

<span data-ttu-id="78fa7-185">如果被动数据库副本中出现损坏 (包括滞后数据库副本), 因为这些副本始终位于其活动副本后面, 所以将任何页面从活动副本复制到被动副本始终是安全的。</span><span class="sxs-lookup"><span data-stu-id="78fa7-185">In case of corruption in a passive database copy, including a lagged database copy, because these copies are always behind their active copy, it is always safe to copy any page from the active copy to a passive copy.</span></span> <span data-ttu-id="78fa7-186">被动数据库副本的本质上是高可用性的, 因此在修补页面过程中, 日志重播已挂起, 但日志复制继续进行。</span><span class="sxs-lookup"><span data-stu-id="78fa7-186">A passive database copy is by nature highly available, so during the page patching process, log replaying is suspended, but log copying continues.</span></span> <span data-ttu-id="78fa7-187">被动数据库副本从活动副本中检索损坏的页面的副本, 一直等到复制和检查满足所需的最大日志生成要求的日志文件, 然后再修补损坏的页面。</span><span class="sxs-lookup"><span data-stu-id="78fa7-187">The passive database copy retrieves a copy of the corrupted page from the active copy, waits until the log file which meets the maximum required log generation requirement is copied and inspected, and then patches the corrupt page.</span></span> <span data-ttu-id="78fa7-188">页面修补后, 日志重播恢复。</span><span class="sxs-lookup"><span data-stu-id="78fa7-188">Once the page has been patched, log replay resumes.</span></span> <span data-ttu-id="78fa7-189">滞后数据库副本的过程相同, 不同之处在于滞后数据库首先重播实现修补状态所需的所有日志文件。</span><span class="sxs-lookup"><span data-stu-id="78fa7-189">The process is the same for the lagged database copy, except that the lagged database first replays all log files that are necessary to achieve a patchable state.</span></span> 

## <a name="mailbox-replication-service"></a><span data-ttu-id="78fa7-190">邮箱复制服务</span><span class="sxs-lookup"><span data-stu-id="78fa7-190">Mailbox Replication Service</span></span> 
<span data-ttu-id="78fa7-191">移动邮箱是管理大规模电子邮件服务的关键部分。</span><span class="sxs-lookup"><span data-stu-id="78fa7-191">Moving mailboxes is a key part of managing a large-scale email service.</span></span> <span data-ttu-id="78fa7-192">始终需要更新的技术和硬件和版本升级, 因此具有强大的受限制系统, 使我们的工程师能够完成此工作, 同时使邮箱对用户保持透明 (通过确保它们保持在线在整个过程中) 是关键的, 并确保在邮箱变大且更大时, 进程能够适当地扩展。</span><span class="sxs-lookup"><span data-stu-id="78fa7-192">There are always updated technologies and hardware and version upgrades to deal with, so having a robust, throttled system that enables our engineers to accomplish this work while keeping the mailbox moves transparent to users (by making sure they stay online throughout the process) is key and making sure that the process scales up gracefully as mailboxes get larger and larger.</span></span> 

<span data-ttu-id="78fa7-193">Exchange 邮箱复制服务 (MRS) 负责在数据库之间移动邮箱。</span><span class="sxs-lookup"><span data-stu-id="78fa7-193">The Exchange Mailbox Replication Service (MRS) is responsible for moving mailboxes between databases.</span></span> <span data-ttu-id="78fa7-194">在移动过程中, MRS 对邮箱中的所有项目执行一致性检查。</span><span class="sxs-lookup"><span data-stu-id="78fa7-194">During the move, MRS performs a consistency check on all items within the mailbox.</span></span> <span data-ttu-id="78fa7-195">如果发现一致性问题, MRS 将纠正此问题, 或跳过已损坏的项目, 从而删除邮箱中的损坏。</span><span class="sxs-lookup"><span data-stu-id="78fa7-195">If a consistency issue is found, MRS will either correct the problem, or skip the corrupted items, thereby removing the corruption from the mailbox.</span></span> 

<span data-ttu-id="78fa7-196">由于 MRS 是 Exchange Online 的一个组件, 因此我们可以在其代码中进行更改, 以解决将来检测到的新的损坏形式。</span><span class="sxs-lookup"><span data-stu-id="78fa7-196">Because MRS is a component of Exchange Online, we can make changes in its code to address new forms of corruption that are detected in the future.</span></span> <span data-ttu-id="78fa7-197">例如, 如果我们检测到 MRS 无法修复的一致性问题, 我们可以分析损坏情况, 更改 MRS 代码并纠正不一致 (如果我们了解如何)。</span><span class="sxs-lookup"><span data-stu-id="78fa7-197">For example, if we detect a consistency issue that MRS is not able to fix, we can analyze the corruption, change the MRS code and correct the inconsistency (if we understand how to).</span></span> 

## <a name="log-file-checks"></a><span data-ttu-id="78fa7-198">日志文件检查</span><span class="sxs-lookup"><span data-stu-id="78fa7-198">Log File Checks</span></span> 
<span data-ttu-id="78fa7-199">Exchange 数据库生成的所有事务日志文件都会经历几种形式的一致性检查。</span><span class="sxs-lookup"><span data-stu-id="78fa7-199">All transaction log files generated by an Exchange database undergo several forms of consistency checks.</span></span> <span data-ttu-id="78fa7-200">创建日志文件时, 完成的第一件事情是写入一个位模式, 然后执行一系列日志写入操作。</span><span class="sxs-lookup"><span data-stu-id="78fa7-200">When a log file is created, the first thing done is a bit pattern is written and then a series of log writes is performed.</span></span> <span data-ttu-id="78fa7-201">这样一来, Exchange Online 就可以执行一系列检查 (丢失刷新、CRC 和其他检查), 以在每个日志文件写入时对其进行验证, 并在复制时再次进行。</span><span class="sxs-lookup"><span data-stu-id="78fa7-201">This enables Exchange Online to execute a series of checks (lost flush, CRC and other checks) to validate each log file as it is written, and again as it is replicated.</span></span> 

## <a name="deployment-on-resilient-file-system"></a><span data-ttu-id="78fa7-202">在弹性文件系统上部署</span><span class="sxs-lookup"><span data-stu-id="78fa7-202">Deployment on Resilient File System</span></span> 
<span data-ttu-id="78fa7-203">为了帮助防止在文件系统级别发生损坏, Exchange Online 将部署在弹性文件系统 (ReFS) 分区上, 以提供改进的恢复功能。</span><span class="sxs-lookup"><span data-stu-id="78fa7-203">To help prevent corruption from occurring at the file system level, Exchange Online is being deployed on Resilient File System (ReFS) partitions to provide improved recovery capabilities.</span></span> <span data-ttu-id="78fa7-204">ReFS 是 Windows Server 2012 及更高版本中的一种文件系统, 旨在更好地防止数据损坏, 从而最大限度地提高数据可用性和完整性。</span><span class="sxs-lookup"><span data-stu-id="78fa7-204">ReFS is a file system in Windows Server 2012 and later that is designed to be more resilient against data corruption thereby maximizing data availability and integrity.</span></span> <span data-ttu-id="78fa7-205">具体说来, ReFS 将改进元数据的更新方式, 从而为数据提供更好的保护并减少数据损坏情况。</span><span class="sxs-lookup"><span data-stu-id="78fa7-205">Specifically, ReFS brings improvements in the way that metadata is updated which offers better protection for data and reduces data corruption cases.</span></span> <span data-ttu-id="78fa7-206">它还使用校验和来验证文件数据和元数据的完整性, 以确保易于找到并修复数据损坏。</span><span class="sxs-lookup"><span data-stu-id="78fa7-206">It also uses checksums to verify the integrity of file data and metadata ensuring that data corruption is easily found and repaired.</span></span> 

<span data-ttu-id="78fa7-207">Exchange Online 充分利用了多个 ReFS 优势:</span><span class="sxs-lookup"><span data-stu-id="78fa7-207">Exchange Online takes advantage of several ReFS benefits:</span></span> 
- <span data-ttu-id="78fa7-208">数据完整性方面的更多恢复意味着较少的数据损坏事件。</span><span class="sxs-lookup"><span data-stu-id="78fa7-208">More resiliency in data integrity means fewer data corruption incidents.</span></span> <span data-ttu-id="78fa7-209">减少损坏事件的数量意味着减少不必要的数据库重新设定种子。</span><span class="sxs-lookup"><span data-stu-id="78fa7-209">Reducing the number of corruption incidents means fewer unnecessary database reseeds.</span></span> 
- <span data-ttu-id="78fa7-210">在元数据上运行的校验和使对损坏情况的检测更快更明确, 使我们能够在数据量出现灰色故障之前解决客户数据损坏问题。</span><span class="sxs-lookup"><span data-stu-id="78fa7-210">Checksum running on metadata enabling detections of corruption cases sooner and more deterministically, allowing us to fix customer data corruption before grey failures occur on data volumes.</span></span>
- <span data-ttu-id="78fa7-211">旨在适用于极大的数据集-pb 和更大的数据集, 而不会影响性能</span><span class="sxs-lookup"><span data-stu-id="78fa7-211">Designed to work well with extremely large data sets—petabytes and larger—without performance impact</span></span>
- <span data-ttu-id="78fa7-212">对 Exchange Online 使用的其他功能 (如 BitLocker 加密) 的支持。</span><span class="sxs-lookup"><span data-stu-id="78fa7-212">Support for other features used by Exchange Online, such as BitLocker encryption.</span></span> 

<span data-ttu-id="78fa7-213">Exchange Online 还可受益于其他 ReFS 功能:</span><span class="sxs-lookup"><span data-stu-id="78fa7-213">Exchange Online also benefits from other ReFS features:</span></span> 
- <span data-ttu-id="78fa7-214">**完整性 (完整性流)** -ReFS 以保护数据的方式存储数据, 这可能会导致通常会导致数据丢失的许多常见错误。</span><span class="sxs-lookup"><span data-stu-id="78fa7-214">**Integrity (Integrity Streams)** - ReFS stores data in a way that protects it from many of the common errors that can normally cause data loss.</span></span> <span data-ttu-id="78fa7-215">Office 365 搜索使用完整性流来帮助早期磁盘损坏检测和文件内容的校验和。</span><span class="sxs-lookup"><span data-stu-id="78fa7-215">Office 365 Search uses Integrity Streams to help with early disk corruption detection and checksums of file content.</span></span> <span data-ttu-id="78fa7-216">该功能还减少了因 "断写" 而导致的损坏事件 (当写操作由于断电等原因而无法完成时)。</span><span class="sxs-lookup"><span data-stu-id="78fa7-216">The feature also reduces corruption incidents caused by “Torn Writes” (when a write operation does not complete due to power outages, etc.).</span></span> 
- <span data-ttu-id="78fa7-217">**可用性 (抢救)** -ReFS 对数据可用性进行优先级划分。</span><span class="sxs-lookup"><span data-stu-id="78fa7-217">**Availability (Salvage)** - ReFS prioritizes the availability of data.</span></span> <span data-ttu-id="78fa7-218">以前, 文件系统通常容易受到数据损坏的攻击, 这可能需要系统脱机才能进行修复。</span><span class="sxs-lookup"><span data-stu-id="78fa7-218">Historically, file systems were often susceptible to data corruption that would require the system to be taken offline for repair.</span></span> <span data-ttu-id="78fa7-219">尽管极少数情况下, 如果发生损坏, ReFS 也会实现抢救, 这是一项功能, 可从实时卷上的命名空间中删除损坏的数据, 并确保不能修复的损坏数据不会对正常的数据产生负面影响。</span><span class="sxs-lookup"><span data-stu-id="78fa7-219">Although rare, if corruption does occur, ReFS implements salvage, a feature that removes the corrupt data from the namespace on a live volume and ensures that good data is not adversely affected by non-repairable corrupt data.</span></span> <span data-ttu-id="78fa7-220">应用抢救功能并将数据损坏隔离到 Exchange Online 数据库卷意味着我们可以将损坏卷上的不受影响的数据库置于损坏和修复操作之间的良好状态。</span><span class="sxs-lookup"><span data-stu-id="78fa7-220">Applying the Salvage feature and isolating data corruption to Exchange Online database volumes means that we can keep non-affected databases on a corrupted volume healthy between the time of corruption and repair action.</span></span> <span data-ttu-id="78fa7-221">这将提高通常受此类磁盘损坏问题影响的数据库的可用性。</span><span class="sxs-lookup"><span data-stu-id="78fa7-221">This increases the availability of databases that would normally be affected by such disk corruption issues.</span></span> 