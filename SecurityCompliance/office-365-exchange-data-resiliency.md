---
title: Office 365 Exchange 数据弹性
ms.author: robmazz
author: robmazz
manager: laurawi
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- Strat_O365_IP
- M365-security-compliance
description: Exchange Online 和 Office 365 中数据弹性的各个方面的说明。
ms.openlocfilehash: 9e61efaf95d466fcb268e12317c7feab0701c062
ms.sourcegitcommit: 0017dc6a5f81c165d9dfd88be39a6bb17856582e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "32262754"
---
# <a name="exchange-online-data-resiliency-in-office-365"></a>Office 365 中的 Exchange Online 数据恢复能力

## <a name="introduction"></a>介绍
有两种类型的损坏可能会影响 Exchange 数据库: 物理损坏通常是由硬件 (尤其是存储硬件) 问题引起的, 以及因其他因素而发生的逻辑损坏。 通常情况下, Exchange 数据库中可能发生两种类型的逻辑损坏: 
- **数据库逻辑损坏**-数据库页的校验和匹配, 但页面上的数据在逻辑上是错误的。 如果数据库引擎 (可扩展存储引擎 (ESE)) 尝试写入数据库页面, 即使操作系统返回成功消息, 但数据永远不会写入磁盘或写入错误的位置, 则可能会发生这种情况。 这称为 "*丢失的刷新*"。 ESE 包含的许多功能和保护措施旨在防止数据库的物理损坏和其他数据丢失场景。 为了防止丢失刷新丢失的数据, ESE 在数据库中包含丢失的刷新机制以及一个功能 (单页还原) 以更正它。 
- **存储逻辑损坏**-以用户不期望的方式添加、删除或操作数据。 这些情况通常都是由第三方应用程序引起的。 通常在用户将其看作损坏时才认为是损坏的。 Exchange 存储会考虑产生一系列有效 MAPI 操作的逻辑损坏的事务。 Exchange Online 中的[就地保留](https://docs.microsoft.com/exchange/security-and-compliance/create-or-remove-in-place-holds)功能提供了对存储逻辑损坏的保护 (因为它会阻止用户或应用程序永久删除内容)。 

Exchange Online 在日志检查和日志重播期间对复制的日志文件执行几项一致性检查。 这些一致性检查防止系统复制物理损坏。 例如, 在日志检查过程中, 有一个物理完整性检查, 它会验证日志文件, 并验证日志文件中记录的校验和是否与内存中生成的校验和相匹配。 此外, 还会检查日志文件头, 以确保日志文件头中记录的日志文件签名与日志文件的签名相匹配。 在日志重播过程中, 日志文件会经历进一步的审查。 例如, 数据库标头还包含与日志文件的签名进行比较的日志签名, 以确保它们相匹配。 

对 exchange Online 中邮箱数据的损坏进行保护是通过使用 exchange 本机数据保护实现的, 这是一种可跨多个服务器和多个数据中心以及其他数据中心使用应用程序级别复制的复原策略帮助防止数据因损坏或其他原因而丢失的功能。 这些功能包括由 Microsoft 或 Exchange Online 应用程序本身管理的本机功能, 如:

- [数据可用性组](https://docs.microsoft.com/exchange/back-up-email)
- 单一位更正 
- 在线数据库扫描 
- 刷新检测丢失 
- 单个页面还原 
- 邮箱复制服务 
- 日志文件检查 
- 在弹性文件系统上部署 

有关上面列出的本机功能的详细信息, 请单击上面的超链接, 并查看有关不带超链接的项目的详细信息。 除了这些本机功能之外, Exchange Online 还包括客户可以管理的数据恢复功能, 如: 
- [单个项目恢复 (默认情况下已启用)](https://docs.microsoft.com/exchange/recipients-in-exchange-online/manage-user-mailboxes/recover-deleted-messages) 
- [就地保留和诉讼保留](https://docs.microsoft.com/exchange/security-and-compliance/in-place-and-litigation-holds) 
- [已删除邮件保留和软删除邮箱 (默认情况下启用)](https://docs.microsoft.com/exchange/recipients-in-exchange-online/delete-or-restore-mailboxes) 

## <a name="database-availability-groups"></a>数据库可用性组 
Office 365 中的每个邮箱数据库都托管在[数据库可用性组 (DAG)](https://docs.microsoft.com/exchange/back-up-email)中, 并复制到同一区域中的地理位置不同的数据中心。 最常见的配置是四个数据中心中的四个数据库副本;但是, 有些区域的数据中心较少 (数据库将被复制到印度的三个数据中心和澳大利亚和日本的两个数据中心)。 但在所有情况下, 每个邮箱数据库都有四个跨多个数据中心分布的副本, 因此可确保邮箱数据免受软件、硬件甚至数据中心故障的保护。 

在这四个副本中, 其中有三个配置为高可用性。 第四个副本配置为[滞后数据库副本](https://docs.microsoft.com/Exchange/high-availability/manage-ha/activate-lagged-db-copies)。 滞后数据库副本不用于单个邮箱恢复或邮箱项目恢复。 其目的是针对系统范围的灾难性逻辑损坏的罕见事件提供恢复机制。 

Exchange Online 中的滞后数据库副本配置了为期七天的日志文件重播延迟时间。 此外, Exchange 重播延迟管理器已启用, 以提供滞后副本的动态日志文件, 以允许滞后数据库副本进行自我修复和管理日志文件增长。 尽管滞后数据库副本在 Exchange Online 中使用, 但务必要了解它们不是一个可保证的时间点备份。 Exchange Online 中的滞后数据库副本具有可用性阈值 (通常约为 90%), 因为由于磁盘故障导致包含滞后副本的磁盘丢失, 因此滞后副本将变为高可用性副本 (由于自动播放), 也是如此在滞后数据库副本重新生成日志重播队列的时段。 

## <a name="transport-resilience"></a>传输弹性 
Exchange Online 包括两种主要传输复原功能: 卷影冗余和安全网络。 "卷影冗余" 在传输过程中保留邮件的冗余副本。 安全网络在邮件成功传递后保留邮件的冗余副本。 

使用卷影冗余时, 每个 Exchange Online 传输服务器都会在确认成功接收发送到发送服务器的邮件之前, 为其接收的每封邮件创建一个副本。 这将使传输管道中的所有邮件在传输过程中冗余。 如果 Exchange Online 确定原始邮件在传输过程中丢失, 将重新发送邮件的冗余副本。 

安全网络是与邮箱服务器上的传输服务相关联的传输队列。 此队列存储服务器成功处理的邮件的副本。 当邮箱数据库或服务器故障需要激活邮箱数据库的过期副本时, 安全网络队列中的邮件将自动重新提交到邮箱数据库的新活动副本。 安全网络也是冗余的, 因此消除了作为单一故障点的传输。 它使用主安全网络的概念和阴影安全网络 (如果主安全网络不可用超过12个小时), 重新提交请求将变为 "卷影重新提交请求", 并从 "卷影安全网络" 重新传递邮件。

来自安全网络的邮件重新提交由管理 dag 和邮箱数据库副本的 Microsoft Exchange 复制服务的活动管理器组件自动启动。 重新提交安全网络中的邮件不需要手动操作。 

## <a name="single-bit-correction"></a>单一位更正 
ESE 包括一种机制, 用于检测和解决因硬件错误而导致的单一位 CRC 错误 (亦称为 "一位翻转") (如此, 它们代表物理损坏)。 发生这些错误时, ESE 会自动更正这些错误, 并在事件日志中记录事件。 

## <a name="online-database-scanning"></a>在线数据库扫描 
在线数据库扫描 (也称为*数据库校验*和) 是一个过程, ESE 使用数据库一致性检查器读取每个页面并检查页面损坏情况。 主要目的是检测事务操作可能无法检测到的物理损坏和丢失刷新。 数据库扫描还会执行存储后崩溃操作。 空间可能因故障而泄漏, 联机数据库扫描发现并恢复丢失的空间。 系统设计时假定每七天完全扫描一次每个数据库。 

## <a name="lost-flush-detection"></a>刷新检测丢失 
当磁盘子系统/操作系统返回为已完成的数据库写入操作实际上没有写入磁盘或写入错误的位置时, 将发生刷新丢失。 丢失刷新事件可能会导致数据库逻辑损坏, 因此, 为了防止丢失因丢失数据而导致的刷新, ESE 包含丢失的刷新检测机制。 在将数据库页面写入被动副本时, 将对活动副本上的丢失刷新执行检查。 如果检测到丢失的刷新, ESE 可以使用页面修补过程修复进程。 

## <a name="single-page-restore"></a>单个页面还原 
单页还原 (亦称为 "*页面修补*") 是一种自动过程, 在正常的副本中由正常副本替换损坏的数据库页面。 损坏页面的修复过程取决于数据库副本是活动的还是被动的。 当活动数据库副本遇到损坏的页面时, 可以从其副本之一复制页面, 前提是它复制的页面完全是最新的。 为此, 请将对页面的请求放入日志流中, 这是邮箱数据库复制的基础。 一旦副本遇到页面请求, 它就会将页面的副本发送到请求数据库副本, 以进行响应。 单页还原还提供了主动的异步通信机制, 可从副本中请求页面, 即使副本当前处于脱机状态也是如此。 

如果被动数据库副本中出现损坏 (包括滞后数据库副本), 因为这些副本始终位于其活动副本后面, 所以将任何页面从活动副本复制到被动副本始终是安全的。 被动数据库副本的本质上是高可用性的, 因此在修补页面过程中, 日志重播已挂起, 但日志复制继续进行。 被动数据库副本从活动副本中检索损坏的页面的副本, 一直等到复制和检查满足所需的最大日志生成要求的日志文件, 然后再修补损坏的页面。 页面修补后, 日志重播恢复。 滞后数据库副本的过程相同, 不同之处在于滞后数据库首先重播实现修补状态所需的所有日志文件。 

## <a name="mailbox-replication-service"></a>邮箱复制服务 
移动邮箱是管理大规模电子邮件服务的关键部分。 始终需要更新的技术和硬件和版本升级, 因此具有强大的受限制系统, 使我们的工程师能够完成此工作, 同时使邮箱对用户保持透明 (通过确保它们保持在线在整个过程中) 是关键的, 并确保在邮箱变大且更大时, 进程能够适当地扩展。 

Exchange 邮箱复制服务 (MRS) 负责在数据库之间移动邮箱。 在移动过程中, MRS 对邮箱中的所有项目执行一致性检查。 如果发现一致性问题, MRS 将纠正此问题, 或跳过已损坏的项目, 从而删除邮箱中的损坏。 

由于 MRS 是 Exchange Online 的一个组件, 因此我们可以在其代码中进行更改, 以解决将来检测到的新的损坏形式。 例如, 如果我们检测到 MRS 无法修复的一致性问题, 我们可以分析损坏情况, 更改 MRS 代码并纠正不一致 (如果我们了解如何)。 

## <a name="log-file-checks"></a>日志文件检查 
Exchange 数据库生成的所有事务日志文件都会经历几种形式的一致性检查。 创建日志文件时, 完成的第一件事情是写入一个位模式, 然后执行一系列日志写入操作。 这样一来, Exchange Online 就可以执行一系列检查 (丢失刷新、CRC 和其他检查), 以在每个日志文件写入时对其进行验证, 并在复制时再次进行。 

## <a name="deployment-on-resilient-file-system"></a>在弹性文件系统上部署 
为了帮助防止在文件系统级别发生损坏, Exchange Online 将部署在弹性文件系统 (ReFS) 分区上, 以提供改进的恢复功能。 ReFS 是 Windows Server 2012 及更高版本中的一种文件系统, 旨在更好地防止数据损坏, 从而最大限度地提高数据可用性和完整性。 具体说来, ReFS 将改进元数据的更新方式, 从而为数据提供更好的保护并减少数据损坏情况。 它还使用校验和来验证文件数据和元数据的完整性, 以确保易于找到并修复数据损坏。 

Exchange Online 充分利用了多个 ReFS 优势: 
- 数据完整性方面的更多恢复意味着较少的数据损坏事件。 减少损坏事件的数量意味着减少不必要的数据库重新设定种子。 
- 在元数据上运行的校验和使对损坏情况的检测更快更明确, 使我们能够在数据量出现灰色故障之前解决客户数据损坏问题。
- 旨在适用于极大的数据集-pb 和更大的数据集, 而不会影响性能
- 对 Exchange Online 使用的其他功能 (如 BitLocker 加密) 的支持。 

Exchange Online 还可受益于其他 ReFS 功能: 
- **完整性 (完整性流)** -ReFS 以保护数据的方式存储数据, 这可能会导致通常会导致数据丢失的许多常见错误。 Office 365 搜索使用完整性流来帮助早期磁盘损坏检测和文件内容的校验和。 该功能还减少了因 "断写" 而导致的损坏事件 (当写操作由于断电等原因而无法完成时)。 
- **可用性 (抢救)** -ReFS 对数据可用性进行优先级划分。 以前, 文件系统通常容易受到数据损坏的攻击, 这可能需要系统脱机才能进行修复。 尽管极少数情况下, 如果发生损坏, ReFS 也会实现抢救, 这是一项功能, 可从实时卷上的命名空间中删除损坏的数据, 并确保不能修复的损坏数据不会对正常的数据产生负面影响。 应用抢救功能并将数据损坏隔离到 Exchange Online 数据库卷意味着我们可以将损坏卷上的不受影响的数据库置于损坏和修复操作之间的良好状态。 这将提高通常受此类磁盘损坏问题影响的数据库的可用性。 